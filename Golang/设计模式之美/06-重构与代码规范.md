# 重构与代码规范

* 1）对重构概括性的介绍，包括重构的目的（why）、对象（what）、时机（when）、方法（how）；
* 2）保证重构不出错的手段，这里我会重点讲解单元测试和代码的可测试性；
* 3）不同规模的重构，重点讲解大规模高层次重构（比如系统、模块、代码结构、类与类之间的交互等的重构）和小规模低层次重构（类、函数、变量等的重构）。

# 1. 重构

### 1. 为什么要重构（why）？

重构是一种对软件内部结构的改善，目的是在不改变软件的可见行为的情况下，使其更易理解，修改成本更低。

在保持功能不变的前提下，利用设计思想、原则、模式、编程规范等理论来优化代码，修改设计上的不足，提高代码质量。

### 2. 到底重构什么（what）？

根据重构的规模，我们可以笼统地分为大规模高层次重构（以下简称为“大型重构”）和小
规模低层次的重构（以下简称为“小型重构”）。

**大型重构**指的是对顶层代码设计的重构，包括：系统、模块、代码结构、类与类之间的关系
等的重构。

重构的手段有：分层、模块化、解耦、抽象可复用组件等等。这类重构的工具就是我们学习过的那些设计思想、原则和模式。

这类重构涉及的代码改动会比较多，影响面会比较大，所以难度也较大，耗时会比较长，引入 bug 的风险也会相对比较大。

**小型重构**指的是对代码细节的重构，主要是针对类、函数、变量等代码级别的重构，比如规
范命名、规范注释、消除超大类或函数、提取重复代码等等。

小型重构更多的是利用我们能后面要讲到的编码规范。这类重构要修改的地方比较集中，比较简单，可操作性较强，耗时会比较短，引入 bug 的风险相对来说也会比较小。你只需要熟练掌握各种编码规范，就可以做到得心应手。

### 3. 什么时候重构（when）？

不要等到代码烂到一定程度了，在重构，那时候可能只有重写了。

比较好的策略是**持续重构**。平时没事的时候就看一下哪些写得不好的代码主动重构优化一下。

> 总之，就像把单元测试、Code Review 作为开发的一部分，我们如果能把持续重构也作为开发的一部分，成为一种开发习惯，对项目、对自己都会很有好处。

### 4. 该如何重构（how）？

大型重构之前需要做好完善的重构计划，分阶段进行，每阶段完成一小部分代码重构，然后提交、测试、运行，没问题后再继续下一部分的重构。一定要保证代码仓库中的代码处于可运行、逻辑正确的状态。

小型重构则耗时比较少，影响范围小，可以随时重构。



## 2. 落地手段

### 1. 单元测试

代码级别测试，测试类或函数是否都按预期逻辑执行。



**单元测试的好处**

* 1）能有效发现代码中的 bug
* 2）能发现代码设计上的问题
  * 如果很难写单元测试则说明代码设计不够合理，耦合度高。
* 3）单元测试是对集成测试的有力补充
* 4）写单元测试的过程本身就是代码重构的过程
* 5）阅读单元测试能帮助你快速熟悉代码
* 6）单元测试是 TDD 可落地执行的改进方案





## 3. 代码可测性



## 4. 如何解耦

* 1）封装、抽象
* 2）中间层
* 3）模块化





## 5. 代码规范

### 1. 命名

1）命名长度

总之，命名的一个原则就是以能准确达意为目标。不过，对于代码的编写者来说，自己对代码的逻辑很清楚，总感觉用什么样的命名都可以达意，实际上，对于不熟悉你代码的同事来讲，可能就不这么认为了。所以，命名的时候，我们一定要学会换位思考，假设自己不熟悉这块代码，从代码阅读者的角度去考量命名是否足够直观。

2）利用上下文简化命名

比如在 user 类中就可以不用写成 userpassword 这种

```go
type user struct {
	Username     string
	UserPassword string
}
type user struct {
	Name     string
	Password string
}
```

