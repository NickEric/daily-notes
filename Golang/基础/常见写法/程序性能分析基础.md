# 程序性能分析基础



### 问题1

**怎样让程序对 CPU 概要信息进行采样？**

这需要用到`runtime/pprof`包中的 API。

更具体地说，在我们想让程序开始对 CPU 概要信息进行采样的时候，需要调用这个代码包中的`StartCPUProfile`函数，而在停止采样的时候则需要调用该包中的`StopCPUProfile`函数。



### 问题2

**怎样设定内存概要信息的采样频率？**

针对内存概要信息的采样会按照一定比例收集 Go 程序在运行期间的堆内存使用情况。设定内存概要信息采样频率的方法很简单，只要为`runtime.MemProfileRate`变量赋值即可。

这个变量的含义是，平均每分配多少个字节，就对堆内存的使用情况进行一次采样。如果把该变量的值设为`0`，那么，Go 语言运行时系统就会完全停止对内存概要信息的采样。该变量的缺省值是`512 KB`，也就是`512`千字节。

> 注意，如果你要设定这个采样频率，那么越早设定越好，并且只应该设定一次，否则就可能会对 Go 语言运行时系统的采样工作，造成不良影响。比如，只在`main`函数的开始处设定一次。



### 问题3

**怎样获取到阻塞概要信息？**

我们调用`runtime`包中的`SetBlockProfileRate`函数，即可对阻塞概要信息的采样频率进行设定。该函数有一个名叫`rate`的参数，它是`int`类型的。

这个参数的含义是，只要发现一个阻塞事件的持续时间达到了多少个纳秒，就可以对其进行采样。如果这个参数的值小于或等于`0`，那么就意味着 Go 语言运行时系统将会完全停止对阻塞概要信息的采样。



### 问题4

**`runtime/pprof.Lookup`函数的正确调用方式是什么？**

`runtime/pprof.Lookup`函数（以下简称`Lookup`函数）的功能是，提供与给定的名称相对应的概要信息。这个概要信息会由一个`Profile`值代表。如果该函数返回了一个`nil`，那么就说明不存在与给定名称对应的概要信息。

`runtime/pprof`包已经为我们预先定义了 6 个概要名称。它们对应的概要信息收集方法和输出方法也都已经准备好了。我们直接拿来使用就可以了。它们是：`goroutine`、`heap`、`allocs`、`threadcreate`、`block`和`mutex`。

当我们把`"goroutine"`传入`Lookup`函数的时候，该函数会利用相应的方法，收集到当前正在使用的所有 goroutine 的堆栈跟踪信息。注意，这样的收集会引起 Go 语言调度器的短暂停顿。



### 问题5

**如何为基于 HTTP 协议的网络服务添加性能分析接口？**

这是因为我们在一般情况下只要在程序中导入`net/http/pprof`代码包就可以了，就像这样：

```go
import _ "net/http/pprof"
```

然后，启动网络服务并开始监听，比如：

```go
log.Println(http.ListenAndServe("localhost:8082", nil))
```

在运行这个程序之后，我们就可以通过在网络浏览器中访问`http://localhost:8082/debug/pprof`这个地址看到一个简约的网页。

