# 疑是内存泄漏

**现象**

机器内存在几秒钟之内迅速占满，然后服务重启，内存得到释放。

几分钟后出现同样的问题，一直循环。

**猜测**

最初认为是程序中存在内存泄漏问题。

于是查看内存占用情况，找到了占用内存最大的那个进程。

**排查**

查看日志，发现打印了大量的，etcd 无法写入的问题，

> 代码中使用了 etcd 做分布式锁

**结果**

程序中有一个并发查询数据库的地方，且每次查询数据比较大。

> 正常情况是获取锁的时候如果其他请求已经获取锁了，当前请求就会等待。

每次获取分布式锁的时候报错了，然后就没有等待直接执行。

> 问题已经很明显了，批量读取数据库，而且每次数据量很大。

所以服务器内存（8G）很快就占满了，于是内存迅速占满的原因找到了。

几分钟出现一次是因为 业务逻辑如此，每过一段时间才会触发这个问题。

**解决**

如果分布式锁（etcd）挂掉了就自己在程序中写一个简单的锁吧。

用 sync.Map 存储上传执行逻辑的实际，限制一段时间内只能执行一次。

**更新**

测试后问题果然得到了解决。



**后续**

去查看了数据库监控，果然是每过几分钟就有大量的查询产生，数据库 cpu分分钟100%。



最大的问题应该是 etcd 为什么出问题了。

检查了发现集群很正常的运行，只是写入数据的时候提示数据满了，具体如下

> error: etcdserver: mvcc: database space exceeded

**原因**

etcd服务未设置自动压缩参数（auto-compact）

etcd 默认不会自动 compact，需要设置启动参数，或者通过命令进行compact，如果变更频繁建议设置，否则会导致空间和内存的浪费以及错误。**Etcd v3 的默认的 backend quota 2GB，如果不 compact，boltdb 文件大小超过这个限制后，就会报错**：”Error: etcdserver: mvcc: database space exceeded”，导致数据无法写入。



后续对 etcd 设置了自动压缩后就没有出现这个问题了。

