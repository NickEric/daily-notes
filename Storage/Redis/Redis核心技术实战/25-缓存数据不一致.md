# 缓存异常



## 缓存数据不一致问题

| 操作顺序                 | 是否有并发请求 | 潜在问题                                 | 现象                                                         | 应对方案                                     |
| ------------------------ | -------------- | ---------------------------------------- | ------------------------------------------------------------ | -------------------------------------------- |
| 先删除缓存，再更新数据库 | 无             | 缓存删除成功，数据库更新失败             | 应用从数据库读到旧值                                         | 重试更新数据库                               |
| 先删除缓存，再更新数据库 | 有             | 缓存删除后，尚未更新数据库，有并发读请求 | 并发请求从数据库读到旧值，并写入缓存，导致后续请求都读到旧数据 | 延迟双删                                     |
| 先更新数据库，在删除缓存 | 无             | 数据库更新成功，但缓存删除失败           | 应用从缓存读到旧数据                                         | 重试删除缓存                                 |
| 先更新数据库，在删除缓存 | 有             | 数据库更新成功后，缓存删除前有并发读请求 | 并发请求从缓存中读到旧数据                                   | 等待缓存删除完成，期间会有短暂数据不一致问题 |



## 缓存雪崩、击穿、穿透

| 问题     | 原因                              | 应对方案                                                     |
| -------- | --------------------------------- | ------------------------------------------------------------ |
| 缓存雪崩 | 1.大量数据同时过期 2.缓存实例宕机 | 1.给缓存过期时间加上随机值，避免同时过期 2.服务降级 3.服务熔断 4.请求限流 5.Redis缓存主从集群（高可用） |
| 缓存击穿 | 访问非常频繁的热点数据过期        | 不给热点数据设置过期时间，一直保留                           |
| 缓存穿透 | 缓存和数据库中都没有要访问的数据  | 1.缓存空值或缺省值 2.请求使用布隆过滤器快速判断 3.前端对请求合法性进行判断（拦截部分请求） |

