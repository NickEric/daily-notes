# 理想索引

## 1. 索引片 & 过滤因子

索引片就是 SQL查询语句在执行中需要扫描的一个索引片段，我们会根据索引片中包含的匹配列的数量不同，将索引分成窄索引（比如包含索引列数为1或2）和宽索引（包含的索引列数大于2）。

如果索引片越宽（包含的列越多），那么需要顺序扫描的索引页就越多；如果索引片越窄（包含的列越少），就会减少索引访问的开销。

### 过滤因子

过滤因子，它描述了谓词的选择性，即列中数据的重复程度。



## 2. 三星索引

三星索引具体指的是：

* 1）在 WHERE 条件语句中，找到所有等值谓词中的条件列，将它们作为索引片中的开始列；
  * 增加索引过滤能力了
* 2）将 GROUP BY 和 ORDER BY 中的列加入到索引中；
  * 方便分组和排序，避免 file sort
* 3）将 SELECT 字段中剩余的列加入到索引中。
  * 避免回表



## 3. 最佳索引

### 1. 为什么理想索引很难实现

但就同三范式一样，很多时候我们并没有遵循三范式的设计原则，而是采用了反范式设计。同样，有时候我们并不能需要完全遵循三星索引的原则，原因主要有以下两点：

* 1）采用三星索引会让索引变宽，这样每个页能够存储的索引数据就会变少，从而**增加了页加载的数量**。

从另一个角度来看，如果数据量很大，比如有1000万行数据，过多索引所需要的磁盘空间可能会成为一个问题，对缓冲池所需空间的压力也会增加。
* 2）**增加了索引维护的成本**。如果我们为所有的查询语句都设计理想的三星索引，就会让数据表中的索引个数过多，这样索引维护的成本也会增加。

举个例子，当我们添加一条记录的时候，就需要在每一个索引上都添加相应的行（存储对应的主键值），假设添加一行记录的时间成本是10ms（磁盘随机读取一个页的时间），那么如果我们创建了10个索引，添加一条记录的时间就可能变成0.1s，如果是添加10条记录呢？就会花费近1s的时间。从索引维护的成本来看消耗还是很高的。当然对于数据库来说，数据的更新不一定马上回写到磁盘上，但即使不及时将脏页进行回写，也会造成缓冲池中的空间占用过多，脏页过多的情况。

### 

所以最佳索引就是**二星索引**：

* 1）首先设计一个索引片尽可能窄（第一颗星）的宽索引（第三颗星）
* 2）如果查询使用时不需要排序，那这个索引就是三星索引。
* 3）否则，这个索引就只能是二星索引，牺牲第二颗星。
* 4）或者采取另一种选择，避免排序，牺牲第一颗星保留第二颗星。

下面我们阐述为查询语句创建最佳索引的算法。

### 2. 候选A

1. 取出对于优化器来说不过分复杂的等值条件列。将这些列作为索引的前导列，以任意顺序皆可。
2. 将选择性最好的范围条件作为索引的下一个列，如果存在的话。最好的选择性是指对于最差的输入有最低的过滤因子。只考虑对于优化器来说不过分复杂的范围条件即可。
3. 以正确的顺序添加order by列，（如果列有DESC的话，加上DESC）。忽略在第一步或第二步已经添加的列。
4. 以任意顺序将select语句中其余的列添加至索引中（但是需要以不易变的列开始）。

### 3. 候选B

  如果候选A引起了所给查询语句的一次排序操作，那么还可以设计候选B。根据定义，对于候选B来说，第二颗星比第一颗星更重要。

1. 取出对于优化器来说不过分复杂的等值条件列。将这些列作为索引的前导列，以任意顺序皆可。
2. 以正确的顺序添加order by列，（如果列有DESC的话，加上DESC）。忽略在第一步中已经添加的列。
3. 以任意顺序将select语句中其余的列添加至索引中（但是需要以不易变的列开始）。

## 4. 小结

首先**一张表的索引个数不宜过多**，否则一条记录的增加和修改，会因为过多的索引造成额外的负担。针对这个情况，当你需要新建索引的时候，首先考虑在原有的索引片上增加索引，也就是采用复合索引的方式，而不是新建一个新的索引。另外我们可以定期检查索引的使用情况，对于很少使用到的索引可以及时删除，从而减少索引数量。

同时，在索引片中，我们也**需要控制索引列的数量**，通常情况下我们将WHERE里的条件列添加到索引中，而SELECT中的非条件列则不需要添加。除非SELECT中的非条件列数少，并且该字段会经常使用到。

另外**单列索引和复合索引的长度也需要控制**，在MySQL InnoDB中，系统默认单个索引长度最大为767 bytes，如果单列索引长度超过了这个限制，就会取前缀索引，也就是取前 255 字符。这实际上也是告诉我们，字符列会占用较大的空间，在数据表设计的时候，**尽量采用数值类型替代字符类型，尽量避免用字符类型做主键，同时针对字符字段最好只建前缀索引**。