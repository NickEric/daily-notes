# MySQL 抖动

## 1. 概述

有时候查询性能会突然抖动一下，大部分时间都很快，突然一段时间很慢。



原因

**脏页刷盘**

InnoDB 在处理更新语句的时候,直接更新内存数据并写入redolog就向客户端返回更新成功了（change buffer机制）

当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“脏页”。内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了，称为“干净页”

**刷脏页时机**

* 1）redolog文件写满
  * redolog是循环写的，写满后只能停下其他工作先将脏页刷盘（刷盘后对应的redolog就不需要了），如果不刷盘，那么redolog被覆盖后可能会出现数据丢失
* 2）内存不足
  * 查询是需要将新页加载到内存中，此时只能将脏页刷盘以腾出空间
* 3）MySQL空闲
  * MySQL觉得系统空闲时也会执行脏页刷盘操作
* 4）关闭MySQL
  * 关闭之前也会执行脏页刷盘操作



**对性能的影响**

* 情况一：需要尽量避免。出现这种情况的时候，整个系统就不能再接受更新了，所有的更新都必须堵住
* 情况二：这种情况是常态，无需过多操作
* 情况三四则不会影响性能



**刷脏页策略**

* 1）相关参数
  * innodb_io_capacity：告诉MySQL当前服务器的io性能，需要根据当前服务器性能设置，太大太小都不行
  * innodb_max_dirty_pages_pct：脏页比例上限（默认值75%）
* 2）参考因素
  * 1.脏页比例
  * 2.redolog写盘速度
  * 说明
    * 刷脏页太快，占用大量IO性能
    * 刷脏页太慢，redolog很快被写满，很快触发前面的情况一

