# 备份与恢复

## 1. 概述

  备份分为：热备、冷备、温备；

  按照备份后文件的内容，分为：逻辑备份、裸文件备份；

  按照备份数据库的内容来分，分为完全备份、增量备份、日志备份



## 2. 冷备

对于InnoDB存储引擎冷备非常简单，只需要备份MySQL数据库的frm文件、共享表空间文件、独立表空间文件(*.idb)和重做日志。另外建议定期备份MySQL数据库的配置文件my.cnf，这样有利于恢复的操作。



优点：

* 备份简单，复制相关文件即可。
* 恢复简单，只需要把文件恢复到指定位置即可。
* 恢复速度快，不需要执行任何SQL语句也不需要重建索引
* 方便在不同操作系统、MySQL版本上进行恢复

缺点：

* 冷备文件通常比逻辑文件大很多
* 也不总是能轻易跨平台，操作系统、MySQL版本、大小写敏感和浮点数都会成为问题

**冷备份必须在数据库关闭的情况下进行**，当数据库处于打开状态时，执行数据库文件系统备份是无效的 。而且在恢复后一定要把数据库文件的属组和属主改为mysql。



## 3. 二进制日志备份与恢复

二进制日志非常关键，用户可以通过它完成point-in-time的恢复工作。

MySQL数据库的replication同样需要二进制日志。



## 4. 热备

ibbackup是InnoDB存储引擎官方提供的热备工具。可以同时备份MyISAM存储引擎和InnoDB存储引擎表。

工作原理如下：

* 1.记录备份开始时，InnoDB存储引擎重做日志文件checkpoint的LSN
* 2.复制共享表空间和独立表空间文件。
* 3.记录复制完表文件后，InnoDB存储引擎重做日志文件checkpoint的LSN
* 4.复制在备份时产生的重做日志。



ibbackup是收费的，不过社区提供的XtraBackup热备工具实现了ibbackup所有的功能。



```sh
#单表
xtrabackup --backup  --tables='jssdb.a' --target-dir=/mnt/data/2 --user=root --password=123456 --socket=/tmp/mysqld.sock

#--tables:单引号中填写databases.tables

##单库
xtrabackup --backup  --databases=jssdb --target-dir=/mnt/data/2 --user=root --password=123456 --socket=/tmp/mysqld.sock

#--databases:库名（database）
```



## 5. 复制

### 1. 原理

MySQL数据库提供的一种高可用高性能的解决方案，总体分为以下3个步骤：

* 1.主服务器(master)把数据更改记录到二进制日志(binlog)中

* 2.从服务器(slave)把主服务器的二进制日志复制到自己的中继日志(relay log)中。

* 3.从服务器重做中继日志中的日志，把更改应用到自己的数据库中，以达到数据的最终一致性。

![](images/mysql-replication-info.png)

复制的工作原理并不复杂，其实就是一个完全备份加上二进制日志备份的还原，是**异步实时**的。



可以看到从服务器有2个线程：

* 1.I/O线程：负责读取二进制日志并将其保存为中继日志；
* 2.SQL线程：负责执行中继日志。

### 2. 主要功能

复制主要功能如下：

* 1.数据分布，在不同数据中心之间实现数据复制
* 2.读取的负载均衡，建立多个从服务器分摊读取压力，从而减小主服务器压力
* 3.数据库备份，复制对备份很有帮助，但是复制不能代替备份
* 4.高可用性和故障转移，通过复制功能建立多个从服务器有助于故障转移和恢复。



通过复制加快照的架构可以避免误操作对从服务器带来的影响。

主服务器发生误操作时，只需要将从服务器上的快照恢复，然后再根据二进制日志进行point-in-time的恢复即可。

![](images/mysql-replication-snapshot.png)



