# 排序及DocValue&Fielddata



Elasticsearch 默认采用相关性算分对结果进行降序排序

可以通过设定 sorting 参数，自行设定排序，如果不指定 _score排序，算分为 Null

 

## 排序过程

* 排序是针对字段原始内容进行的。倒排索引无法发挥作用。
* 需要用到正排索引。通过文档 id 和字段快速得到字段原始内容
* Elasticsearch 有两种实现方法
  * Fielddata
  * Doc Values （列式存储，对 Text 类型无效）
    * 所以对 Text 类型排序时，需要打开 Fielddata，因为 Doc Values 用不了，只能用 Fielddata

| /        | Doc Values                     | Field data                                    |
| -------- | ------------------------------ | --------------------------------------------- |
| 何时创建 | 索引时，和倒排索引一起创建     | 搜索时动态创建                                |
| 创建位置 | 磁盘文件                       | JVM Heap                                      |
| 优点     | 避免大量内存占用               | 索引速度快，不占用额外的磁盘空间              |
| 缺点     | 降低索引速度，占用额外磁盘空间 | 文档过多时，动态创建开销大，占用过多 JVM Heap |
| 缺省值   | ES 2.x 之后默认采用            | ES 1.x 及之前默认采用                         |

> 不建议 使用 Field data，给全文本排序本就没有多大意义



**关闭 Dock Values**

> 一般不建议关闭

* 默认开启，可以通过 Mapping 设置关闭
  * 增加索引的速度，减少磁盘空间
* 如果重新打开，需要重建索引
* 什么时候需要关闭
  * 明确不需要做排序及聚合分析



