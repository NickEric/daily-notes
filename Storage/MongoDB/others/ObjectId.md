## _id和ObjectId

MongoDB 中存储的文档**必须**有一个`_id`键。这个键可以是任意类型的，默认是 ObjectId 对象。

在每个集合中，每个文档都有唯一的`_id`值，来确保`集合`里面的每个文档都能被`唯一标识`。

> 所以不同的集合里_id是可以重复的。

#### 1. ObjectId

ObjectId 是 _id 的默认类型。它设计成轻量型，不同的机器都能用户`全局唯一`的同种方法方便地生成它。

> 采用 ObjectId 而不是常规做法(比如自增主键)，因为在多个服务器上同步自增主键既费时还费力。MongoDB 一开始就被设计用来做分布式数据库，处理多节点是核心要求。

ObjectId 使用 12 字节的存储空间，每个字节处理两位16进制数字，是一个24 位的字符串。由 4 部分组成：

* Time 4字节

* Machine 3字节
* PID 2字节
* INC 3字节



当成插入随机生成的 ObjectId 为`5ed463961c74900ec8482006`

**Time**

时间戳。其中时间戳为前 4 个字节：`5ed46396`

这是16进制，转为10进制之后为`1590977430`即`2020-06-01 10:10:30`

**Machine**

机器码。接下来的 3 个字节`1c7490`是机器码。这是主机的唯一标识符,一般是机器主机名的散列值。

> 这样就确保了不同主机生成不同的机器hash值，确保在分布式中不造成冲突。
>
> 这也就是在同一台机器生成的objectId中间的字符串都是一模一样的原因。

**PID**

进程ID。接下来的 2 字节`0ec8`是进程 ID。

Machine 确保了不同机器产生的 ObjectId 不冲突，PID 则保证了同一机器上的不同 MongoDB 进程产生的 ObjectId 不冲突。



**INC**

自增计数器。最后 3 个字节`482006`是自增计数器，用于保证同一秒内产生的 ObjectId 也不冲突。

> 3 字节可以保证一秒内生成 2^24 次方(大约1670W)条记录 ObjectId 也不冲突。

#### 2. 小结

ObjectId 的前 4 个字节时间戳，记录了文档创建的时间；

接下来3个字节代表了所在主机的唯一标识符，确定了不同主机间产生不同的objectId；

后2个字节的进程id，确定了在同一台机器下，不同mongodb进程产生不同的objectId；

最后通过3个字节的自增计数器，确保同一秒内产生objectId的唯一性。

ObjectId的这个主键生成策略，很好地解决了在分布式环境下高并发情况主键唯一性问题，值得学习借鉴。



#### 3. 自动生成_id

插入文档的时候如果没有`_id`键，那么系统会自动创建一个。可以由 MongoDB 服务器来完成，但是一般在客户端驱动程序完成：

* 1) 降低服务端的负担
* 2） 客户端驱动可以提供更加丰富的API，比如 insert 之后返回 ObjectI d 等等。

